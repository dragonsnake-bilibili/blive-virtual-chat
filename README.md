# BLive Virtual Chat: Bilibili 虚拟弹幕姬

这是一个对 Bilibili 直播中常见弹幕呈现工具的模仿

## 这是干啥的？

在进行直播视频剪辑（人话：切片）时，可能会遇到需要展示直播时弹幕的情形。然而在实际处理中可能还会一并遇到这些情况：

- 弹幕在画面中的占比小，需要放大展示，可一旦放大又很容易糊成一团；
- 一些主播直接不在直播画面中显示普通弹幕，有的人想放大还没得放呢；
- 弹幕跑得太快或是想要连续呈现的弹幕实际视频中不是连续的，剪辑起来不自然和费时间总得选一个；
- 想移动一下弹幕位置可是背景太乱只能带着背景硬放，或者背景很纯但色键一上毛边就来了

AI超分或者去背景是可行的方案，多数弹幕展示效果的前背景区分相对明显，去除背景未免有杀鸡用牛刀的嫌疑，效果预期较好，不过面对重排顺序或是直接无中生有的需求就不是那么轻松了，而目前超分更难以生成与直接使用更大尺寸渲染质量相接近的效果，对于文字部分更是如此。在此之上，使用这些工具通常是有着更大开销的，尤其是效果好质量高的工具。

想要应对全部困难，基本只能依靠重新制作弹幕图片来实现。使用弹幕姬重新显示弹幕能够得到最接近原始的效果，但需要的配置较复杂；修图或使用各种其它工具合成可能达成很高的质量，但难以批量化。同时，如何在合成视频时保持图像质量、动画效果和帧率稳定则是两种方法均要面对的问题，合成过程的性能需求和资源开销也值得考虑。

BVC实现了一个相对简单但具有丰富可配置项的工具，用于使用预设主题显示任意时间出场的自定义内容弹幕，并支持快速预览和高效视频合成，辅助制作弹幕展示部分。

## 功能特性

- 高度可定制，以下属性均可配置
  - 全局设置（对全局场景或所有消息条目生效）
    - [场景模式：堆叠或弹幕](#场景模式)
    - 场景背景（仅支持纯色，可设置透明度）
    - 场景尺寸（宽高）
    - 录制时渲染帧率
    - 最大消息宽度
    - 消息间距
    - 消息中字体/头像/徽章/表情的尺寸
    - 消息位置调整时长和消息入场时长（不同场景模式下有不同含义）
    - 预览/录制开始前等待时间（呈现空场景）
    - 预览/录制开始后保持时间（呈现场景最终状态）
  - 消息设置（每个消息独立配置生效）
    - 入场时刻
    - 用户名
    - 用户徽章（房管、舰长等）
    - 用户头像
    - 消息内容（支持表情和定长空白，工具包含内建表情选择器，详见[消息内容编辑器](#消息内容编辑器)）
- 支持多种主题样式，每个主题可添加新的全局和消息设置项，详见[主题支持](#主题支持)
- 支持任意表情和自定义表情，可按需构建和添加表情包
- 可在渲染前基于网页动画快速预览（注意预览效果与最终渲染结果可能存在细微差别）
- 可单独渲染单个消息的图像
- 可渲染透明背景视频，在剪辑工具中无需任何色键等后期处理直接按层次叠加呈现（需要剪辑工具支持，目前应该已较为广泛）
- 精确渲染结果，与配置尺寸等保持像素级严格一致
- 支持较为精确（指使用JavaScript标准浮点数计算，未对浮点误差做特殊控制）的任意帧率渲染
- 注重性能和资源开销
- 支持配置和内容的导出与导入

### 场景模式

场景模式决定了消息如何在场景中排布，与其具体内容无关，可与主题独立配置。BVC支持两种场景模式，分别是堆叠模式和弹幕模式。对于每一种模式均可设置主轴方向为水平或垂直、移动方向为默认或反向。主轴方向表示由场景驱动的消息移动应沿哪条坐标轴进行，而移动方向决定了沿主轴的正向或反向进行移动。对于水平主轴，默认方向为从右到左；对于垂直主轴，默认方向为从下到上。此三项配置构成的8种组合能够基本应对目前见到的所有样式。

#### 堆叠模式

堆叠模式表示所有消息按照主轴方向排列成一个连续的列表，类似聊天工具中的消息列表。每当新的消息入场时，场景控制器负责将已经入场的消息将沿配置的主轴和方向一同移动，从而为即将入场的新消息预留出所需要的空间。

该模式下全局设置中的消息位置调整时长表示已入场消息为新消息空出空间进行移动需要花费的时间，消息入场时长表示新消息入场（入场动画播放）所需的时间。新消息的入场动画将在位置调整完毕的时刻开始，即这两部分时长不存在重叠。

#### 弹幕模式

弹幕模式即常见的弹幕效果，场景控制器根据各个消息的入场时间安排各消息独立发射，沿指定主轴方向从场景一侧飞入场景并最终从对侧飞出场景。控制器负责对弹幕轨道进行管理，保证轨道存在重叠的消息不会追近彼此到一定距离之内。

该模式下全局设置中的消息位置调整时长控制允许轨道存在重叠的消息追近彼此的最近距离，该最近距离为两者中移动速度较慢的一方经过消息位置调整时长后可移动的距离。如若两个消息移动速度分别为0.3像素每毫秒和0.4像素每毫秒，且消息位置调整时长为100毫秒，则控制器只有在两者的入场时间保证两者间沿主轴的距离不会小于30像素时方可能为两者分配存在重叠的轨道。

该模式下全局设置中的消息入场时长决定消息从开始入场（消息边界与场景边界第一次相切的时刻，也就是消息设置中的入场时刻）到完全入场（消息的全部内容可见或曾可见的最早时刻）的间隔，即消息移动自身在主轴方向上长度所需的时间。该项设置决定了消息的移动速度，主轴方向长度更长的消息将具有更快的移动速度。

### 主题支持

主题系统用以支持以不同风格样式结构呈现相同的消息内容，并可在不同配置之间快速切换。主题可以添加新的全局设置，也可以为每一个消息引入新的独立配置项。

#### 现有主题

这一节展示了BVC目前内置的全部主题，并在预览图片中标注了其各自添加的所有新可配置项及含义。预览图片中的用户名和/或头像为对应主题的主要开发/实现者。

##### 仿聊天气泡

![仿聊天气泡](./images/theme-chat-bubble.png)

##### 极简紧凑

![极简紧凑](./images/theme-plain.png)

##### 菲可变高度卡片

![菲可变高度卡片](./images/theme-phixed-height.png)

##### 简洁轻动画

![简洁轻动画](./images/theme-simple-animation.png)

#### 开发相关

_如果你没有为此工具贡献代码、调试或进行二次开发的需求，通常不需要阅读这一节内容。_

##### 架构设计

简单的说，整个BVC的预览和渲染架构是“场景管理消息的包围盒，主题管理包围盒中的内容”。在场景的视角中，任何主题中的任何消息都是一个矩形的包围盒，场景负责将这些包围盒按照场景模式进行排列，确保包围盒在正确的时间出现在正确的位置，即对于堆叠模式沿主轴方向排列成列表，彼此之间预留指定的间距，并随新包围盒出现整体移动为新包围盒空出空间；弹幕模式下为包围盒分配轨道确保彼此不会重叠或相距过近并发射。因此，主题只需向场景提供各个消息的准确包围盒尺寸，其余整体上的工作就可以交给场景控制器完成，无需主题实现关心。

主题本身则关心每个消息具体的显示细节，即应该在包围盒中填入什么内容。主题负责如何将消息的内容呈现出来，渲染文本图片、实现动画效果等等。这包含两个部分，分别是预览模式，内容作为网页元素呈现，包围盒尺寸通过消息最外层元素的长宽自动计算；以及渲染模式，全部的内容和动画需要按帧在canvas上绘制，并自行计算包围盒的尺寸。

##### 实现新主题

所有主题的实现在`src/components/chat-themes/`目录下，每个主题一个目录。如果想要实现新的主题，请参考下面的检查单和提示。

- 确定主题名称。主题名称应该较为直观的表现其样式风格，长度不宜过长（考虑不超过10个汉字），且不可与已存在主题名重复。
- 实现主题接口。主题接口在`src/components/chat-themes/interface.ts`中定义，即`ThemeSpecification`。接口由如下成员组成，下方列表只是简要概括，详细约定请见注释：
  - `name`：主题的名称
  - `global_configure`：用于配置新全局设置的配置面板，Vue组件。该面板会在切换到当前主题时挂载到页面上，直到切换到其它主题为止不会被卸载。可以在被挂载时初始化全局配置，所有配置必须有合理的默认（初始）值。
  - `display`：用于预览模式的渲染，Vue组件。在编辑模式下同样会使用该组件的实例展示当前已添加的消息列表。`paragraph-display`组件提供了对包含表情、定长空白等特殊内容的渲染，可以直接使用或参照其实现。为了使全局设置正确生效和场景控制器正常工作，组件应满足下述约定：
    - 组件的最外层容器应该可以被CSS选择器`.chat-container`选中。该容器应该准确反映消息条目的包围盒。
    - 内容中表情应该可被CSS选择器`img.chat-content-image`选中。若使用`paragraph-display`则无需关心。
    - 内容中徽章应该可被CSS选择器`img.chat-logo`选中
    - 内容中头像应该可被CSS选择器`.chat-avatar`选中
  - `editor`：用于配置主题新引入的消息设置的面板，Vue组件
  - `prepare_chat`：初始化消息配置的函数。当切换主题时，消息配置中当前主题所需要的配置项尚未初始化，且可能遗留之前主题的配置内容。为了简化组件的逻辑，BVC将首先使用该函数处理所有已经存在的消息配置，随后再完成切换。对于添加新消息的场景同样会在其配置项经过此函数初始化后再将编辑面板挂载，因此组件中总是可以假设所有消息配置项是已初始化的。
  - `render`：独立渲染单个消息的函数。用于实现消息编辑器中渲染按钮的功能，无视场景设置（场景背景、可视区域大小等）渲染当前消息的图像。在渲染中所有操作需要在canvas上完成，`src/utilities/rendering.ts`中提供了绘制圆角矩形等常用工具函数，`src/utilities/text-rendering.ts`中提供了在canvas上绘制支持自动换行的段落的工具函数，且支持渲染表情、定长空白等特殊内容，可简化实现。**注意**：在渲染过程中，如果全局设置中的`debug`为`true`，可以在控制台输出少量辅助调试的信息或是在渲染结果上渲染额外辅助线框等信息用于核查，但无论何时，不要使用控制台向用户传递消息。使用`useDialog`和其上提供的`show_dialog`方法显示对话框。
  - `prepare_entering_animation`：配置预览模式下的进场动画。消息的常驻动画在预览模式应当直接实现到组件中，而进场动画通常为淡入等仅在预览中进场时应用，这个函数将在准备预览动画时被调用，主题负责将所需的临时动画使用Web Animation API注册到元素上，并提供移除所做临时更改的函数。注意场景管理器不会负责在入场时刻开始播放所注册动画，而是在预览开始时（开始前等待时间之后）播放全部动画，因此需要自行设置动画延迟。可以通过传入的全局设置查看当前预览的场景模式并根据模式设置对应的动画，如弹幕模式可能通常不添加入场动画。注意如果用到了自定义的CSS类，应将其放置在新主题自身的目录下。
  - `prepare_rendering`：准备渲染的函数。当渲染到达消息的进场时刻时被调用，供主题准备当前消息渲染需要的资源素材、预渲染并缓存将大量复用的图像、计算包围盒尺寸等。该函数的返回类型和语义较为复杂，请详细参见注释。简单来说，如果没有任何入场和常驻动画，直接返回消息渲染的结果图像即可交由场景控制器自动管理定位；否则返回一个提供渲染函数的对象，该渲染函数将在之后的每一帧被调用由主题完成自定义渲染，直到主题向场景控制器报告其工作已经结束。注意主题必须考虑场景的不同模式和方向。为简化方向的处理，定义了两种尺寸，分别是标准尺寸和有向尺寸：标准尺寸`Size`的成员为`width`和`height`，其永远表示宽和高，即水平方向上的长度和竖直方向上的长度；有向尺寸`DirectedSize`的成员为`length`和`breadth`，分别表示沿主轴方向的长度和沿交叉轴（即垂直于主轴的坐标轴）的长度，其具体方向是随着主轴设置不同而变化的。`to_directed_size`和`to_standard_size`两个函数提供了根据主轴设置在两者之间相互转换的方式，利用这些设施可使实现更语义化和简洁。同时，`get_flow_sign`函数可给出移动方向对应的符号，即方向为从左到右或从上到下时为1，否则为-1。注意坐标`Coordinate`只有一种，即原点位于图像左上角，`x`为水平轴坐标向右增加，`y`为竖直轴坐标向下增加。
- 填写`entry.ts`，其应该是新主题目录的直接子文件，默认export一个`ThemeSpecification`类型的对象，即为上述主题接口。该文件会被自动引入和解析并作为新的可选主题出现。
- 添加预览图。使用新主题渲染一个消息的图像，消息的头像和用户名设置为主要开发/实现者的头像和id，内容应为主题的名称。尽可能在该渲染图上标注该主题添加的所有新可配置项，全局和消息配置应区分标注。如果单条消息无法呈现所有可配置项考虑渲染多条消息并拼接为一张图片，除第一条消息之外的消息内容可自行设计。除非配置项含义极其直观明显，否则应该标注所有添加的可配置项。预览图应按照现有格式添加到[现有主题](#现有主题)一节中。

### 消息内容编辑器

BVC内建了一个简单的消息内容编辑器，除文本输入之外还包含了一个表情选择器，用以在内容中输入表情。表情选择器可从打包好的表情包中动态加载表情集，并重复使用。由于版权方面的担忧，BVC未内建任何表情，使用者可自行从Bilibili或其它途径获取表情并使用`src/utilities/emote-packer.py`将其打包为可加载的表情包进行使用。

## 使用方式

在本仓库的main和develop两个主要分支上的新commit将由GitHub Actions自动构建并部署到[https://dragonsnake-bilibili.github.io/bvc/](https://dragonsnake-bilibili.github.io/bvc/)，其中main分支对应稳定版，该版本通常经过了更多测试，因此更为可靠，但可能更新周期较长，不会第一时间得到最新功能；develop分支对应测试版，通常在新功能开发完毕并经过初步测试后即进入该分支，相对出现问题的概率更高，但能更快使用新功能。

为了保存渲染结果，需要在本地运行一个辅助Python程序，因此需要[安装Python](https://www.python.org/downloads/)。需要运行的Python程序的获取路径将在点击渲染按钮且BVC未检测到已运行的程序时通过对话框告知。该程序依赖于FFmpeg编码视频，需要[自行下载安装](https://ffmpeg.org/download.html)。

## 已知问题

- 最终渲染需要在本地运行Python程序和少量依赖进行支持。目前浏览器上可用的视频编码API对格式支持较窄且难以控制输出高帧率、高质量的透明背景视频，依赖本地安装少量环境予以支持。
- 弹幕模式轨道分配的算法会漏掉一些可行的分配方案。当前实现将场景全可用空间划分为若干片连续的已占用或未占用区间，新消息可被分配一片足够尺寸的未占用空间，也可被分配一片足够尺寸的已占用空间，但分配无法跨越多个连续片。即若新消息需要空间为200，而两片已分配的区间分别为$\left[0, 100\right)$和$\left[100, 200\right)$，即使两片中的消息已经和新消息拉开了足够距离且不会被追上，分配器目前也无法将新消息在$\left[0, 200\right)$上发射。
- 不支持动图。头像、表情中的动图目前在渲染结果中将保持静止。
- 渲染中可能在不适合断行处断行，如日语拗音中间。
